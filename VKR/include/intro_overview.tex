\subsection{Модели сверхширокоугольной камеры}
\label{camera_model}
Сложности, возникающие при использовании существующих алгоритмов стереозрения  в применении к сверхширокоугольным камерам, связаны с
 особенностями их оптической системы. Объективы  этих камер имеют в своей основе сложную систему линз, пример схемы которой вместе с примером
 получаемого изображения представлены на рисунке \ref{pic:fyscheme}. Особенности этой системы позволяют достигать очень высоких углов обзора,
  но также являются причиной аберрации и характерных искажений изображения. Чтобы описать свойства проецирования широкого набора таких
камер исследователи прибегают к аппроксимациям, называемым моделями камер. 


Модель проекции для камеры это функция, которая описывает преобразование из точки трёхмерного пространства  в области зрения 
камеры ($P=[x_c, y_c, z_c]^T$) в точку на плоскости изображения ($p=[u, \nu]^T$), как показано на \ref{pic:fy_geom}. Единичная            % не совсем единичная 
полусфера $S$ с центром в точке $O_c$ на данной схеме описывает поле зрения. На ней также лежит точка $P_C$, являющаяся результатом обратной проекции.    %$\pi^{-1}_c({p})$
Угол $\theta$ является углом падения для рассматриваемой точки, а угол $\phi$ откладывается между положительным направлением оси $x$ и $O_{i}{p}$. 

\addtwoimghere{fisheye_scheme}{0.45}{fisheye_example}{0.45}{Схема хода лучей объектива "рыбий глаз" (слева), пример изображения (справа)\cite{fy_exmp}}{pic:fyscheme}

Помимо самой проекции модели камер включают в себя описания нескольких типов искажений, накладываемых линзой. В сверхширокоугольных объективах самыми существенными являются 
радиальные - искажения, проявляющиеся сильнее по мере удаления от проекционного центра. Поэтому далее в этой секции модели будут рассматриваться именно с точки зрения 
описания радиальных искажений. Так как в этом случае искажения хода луча считаются центрально симметричными и зависят только от его удаления от центра изображения, 
большинство моделей используют координаты $\theta$ и  $r$, отмеченные на рисунке \ref{pic:fy_geom}.
% где $\lambda = \rho_c / \rho_i$ - масштабный коэффициент. 

% \addimghere{scara_graph}{0.5}{Нахождение обратной проекции для используемой модели}{pic:scara_graph} 
\addimghere{projection_geometry}{0.5}{Схема проекции точки трёхмерного пространства в точку на изображении}{pic:fy_geom}

Перспективная проекция, которая обычно используется в качестве модели ортоскопической камеры, не способна спроецировать всё широкоугольное пространство на кадр 
конечного размера. Поэтому при описании и разработке fisheye-объективов опираются на другие виды проекций  \cite{projections}:

\begin{eqseries}
    \begin{equation}
        \label{fy1}
    r = 2 f tan(\theta/2),  
    \end{equation}
    \begin{equation}
        \label{fy2}
    r = f \theta,
    \end{equation}
    \begin{equation}
        \label{fy3}
    r = 2 f sin(\theta/2),
    \end{equation}
    \begin{equation}
        \label{fy4}
    r = f sin(\theta).
    \end{equation}
\end{eqseries}    

Но реальные искажения не всегда в точности следуют заданным уравнениями.
По этой причине fisheye-проекции выгоднее аппроксимировать другими функциями \cite{opencv_model}.
В настоящий момент есть несколько распространённых моделей, аппроксимирующих реальные искажения подобных объективов. 

\subsubsection{Модель Канналы-Брандта}

Модель Канналы и Брандта \cite{opencv_model} для линз с радиально симметричными искажениями реализована в OpenCV и 
выражает их через угол падения луча света на линзу, а не расстояние                                                              \pdfmargincomment{https://stackoverflow.com/questions/31089265/what-are-the-main-references-to-the-fish-eye-camera-model-in-opencv3-0-0dev}
от центра изображения до места падения, как это делалось в более ранних моделях. Авторы посчитали, что для описания типичных искажений достаточно 
пяти членов полинома с нечётными степенями. Таким образом, указанную модель можно записать следующими уравнениями:
\begin{eqseries}
    \begin{equation}	
        \delta r = k_1\theta + k_2\theta^3 + k_3\theta^5 + k_4\theta^7 + k_5\theta^9,
        \label{eqn:kannala_r}
    \end{equation}
    \begin{equation}	
        \begin{pmatrix}u\\v\end{pmatrix} = \delta r(\theta)\begin{pmatrix}cos(\phi)\\sin(\phi)\end{pmatrix},
        \label{eqn:kannala_uv}
    \end{equation}
\end{eqseries}

где $\theta$ - угол падения луча, определяемый выбранным типом проекции,

\qquad $\phi$ - угол между горизонтом и проекцией падающего луча на плоскость изображения, 

\qquad $r = sqrt(x^2+y^2)$ - расстояние от спроектированной точки до центра изображения, 

\qquad $f$ - фокусное расстояние, 

\qquad $k_1 \dots k_5$ - параметры модели.

\subsubsection{Модель Мея}

Модель Мея \cite{mei} является более общей версией модели Гейера \cite{geyer} и позволяет использовать разные 
функции искажения для моделирования зеркал разоичного вида. Изначально она была создана для более 
эффективного моделирования катадиоптрических камер, но оказалась также весьма пригодной и для сверхширокоугольных камер. 
Калибровку этой модели можно произвести, используя библиотеку CamOdoCal. Записывается она следующим образом:

\begin{equation}
    \vspace{12pt}
    \begin{pmatrix}u\\v\end{pmatrix}=\left[\begin{array}{l}
	f_{x} \frac{x}{\alpha d+(1-\alpha) z} \\
	f_{y} \frac{y}{\alpha d+(1-\alpha) z}
	\end{array}\right]+\left[\begin{array}{l}
	c_{x} \\
	c_{y}
	\end{array}\right]
    \vspace{12pt}
\end{equation}

где $\alpha$ - параметр модели. 

\subsubsection{Модель Скарамуззы}

Также большое распространение получила модель Скарамуззы \cite{scaramuzza}, которая легла в основу Matlab Omnidirectional 
Camera Calibration Toolbox. Она связывает точки на изображении с соответствующей им точкой в координатах камеры
следующим образом:
\vskip 12pt
\begin{equation}	
    \begin{pmatrix}X_c\\Y_c\\Z_c\end{pmatrix} = \lambda \begin{pmatrix}u\\v\\a_0 + a_2 r^2 + a_3 r^3 + a_4 r^4\end{pmatrix},
    %\delta r = k_1\theta + k_2\theta^3 + k_3\theta^5 + k_4\theta^7 + ... + k_n\theta^{n+1}
    \label{eqn:scaramuzza} 
\end{equation}
\vskip 24pt

где $a_0 ... a_4$ - коэффициенты, описывающие параметры модели,

\qquad $\lambda$ - масштабный коэффициент.

Обратная проекция записывается следующим образом.
\vskip 12pt
\begin{equation}
    \label{eq:back_scara}
    \left[\begin{matrix}u_i\\v_i\\\end{matrix}\right] = \left[\begin{matrix} \frac{x_c}{\lambda}  \\  \frac{y_c}{\lambda} \\\end{matrix}\right],
\end{equation} 
\vskip 24pt
где $\lambda = \rho_c / \rho_i$. 

$\rho_i$ при этом является неизвестной. Чтобы найти её для каждого пикселя был применён метод последовательных приближений, опирающийся на прямую проекцию.
 Блок-схема алгоритма, реализующего обратную проекцию, изображена  на рисунке  \ref{pic:newton_scheme}.  Сравнение результатов выпрямления изображения инструментом  
калибровки и описанного алгоритма для центральной области изображения представлено на рисунке \ref{pic:central_pics}. 

\addimghere{flowchart}{0.5}{Блок-схема алгоритма обратной проекции}{pic:newton_scheme} 

\addimghere{remapped_images}{0.8}{Изображения, скорректированные алгоритмом (слева) и MATLAB (справа)}{pic:central_pics} 

\subsubsection{Модель Двух сфер}  % FIXME: убрать ??

Существуют и менее распространённые модели, не использующие полиномы для описания искажений. Одной из них является
модель двух сфер \cite{double_sphere}. 
Она находит положение пикселя, проектируя точку в несколько этапов - сначала на первичную сферу, потом на вторую 
сферу меньшего диаметра и смещённую на расстояние $\xi$. Наконец точка проецируется на  плоскость изображения,
 сдвинутую на расстояние $\frac{\alpha}{1-\alpha}$ относительно центра второй сферы. Модель проекции представлена 
на рисунке \ref{pic:ds_model}. Таким образом, для описания радиальных искажений достаточно всего двух параметров.
 Модель также реализована в нескольких популярные программ для калибровки камер (Basalt, Kalibr). 
 Записывается она следующим образом:
\begin{eqseries}
    \begin{equation}	
        d_1 = \sqrt{x^2+y^2+z^2}, 
    \end{equation}
    \begin{equation}	
        d_2 = \sqrt{x^2+y^2+(\xi*d_1+z)^2 }, 
    \end{equation}
    \begin{equation}	
        \begin{pmatrix}u\\v\end{pmatrix} = \begin{pmatrix}f_x * \frac{x}{\alpha*d_2+(1-\alpha)(\xi*d_1+z)} \\
                                                    f_y * \frac{y}{\alpha*d_2+(1-\alpha)(\xi*d_1+z)} \end{pmatrix}.
        %\delta r = k_1\theta + k_2\theta^3 + k_3\theta^5 + k_4\theta^7 + ... + k_n\theta^{n+1}
        \label{eqn:ds}
    \end{equation}
\end{eqseries}
\addimghere{double_sphere}{0.7}{Модель  двух сфер}{pic:ds_model}

Так как представленные модели никогда не сравнивались в пригодности для стереосопоставления, дальнейшие
эксперименты будут выполняться с применением их всех.

\vspace{\baselineskip}